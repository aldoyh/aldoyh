name: Update README with Todoist Stats

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */8 * * *" # Runs every 8 hours

jobs:
  update-readme:
    name: Update README.md with Todoist Stats
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code ⛵️
        uses: actions/checkout@v2
        with:
          ref: main
          token: secrets.GH_PAT 

      - name: Setup Node.js environment 🌍
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install dependencies
        run: npm install axios humanize-plus

      - name: Update README.md with Todoist Stats
        id: todoist
        env:
          TODOIST_API_KEY: secrets.TODOIST_API_KEY
        run: |
          node readmeTodoist.js

      - name: Check for changes in README.md 📝
        id: diffcheck
        run: |
          git diff --exit-code --quiet origin/main README.md || echo "difference=true" >> $GITHUB_ENV
          git add .
          git commit -m "Update README.md"

      - name: Merge into main 📦
        if: 
        run: |
          git checkout main
          git merge --no-ff todoist-update
          git push origin main